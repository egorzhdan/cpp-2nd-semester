## Оптимизации

`mmap`/`munmup` настраивают mapping виртуальной памяти.
Вызовы этих функций из программы дорогие.
`malloc`/`free` работают быстрее.
Когда запрашиваем память у ОС, она зануляет страницы, чтобы нельзя было прочитать память недавно закрытой программы.
Это работает долго.

Аллокатор получает кусок памяти от ОС, разбивает его на равные куски, 
и использует их для `malloc`/`free`.
Заводят несколько таких аллокатороов разных размеров.

Если объект большой, то используют дерево поиска. Но таких объектов мало.

Можно сделать кастомный аллокатор и заставить ОС его использовать 
через переменную окружения `LD_PRELOAD=mymalloc firefox`.

### Small object

Посмотрим на все строки в программе. В основном они небольшой длины.
Строка должна хранить size, capacity, data.

Если размер строки небольшой, она хранит данные там, где обычно хранит указатель.
То есть для строк < 16 Байт можно не аллоцировать память.

```cpp
struct string {
    size_t size;
    union {
        struct {
            char* data;
            size_t capacity;
        };
        
        char inplace_storage[sizeof(char*) + sizeof(size_t)];
    }
}
```

Выигрываем и по памяти тоже засчет кеша.
